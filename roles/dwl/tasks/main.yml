---
- name: Build list of repo dependencies
  ansible.builtin.set_fact:
    dwl_repo_deps: "{{ dwl_build_deps_base + ([wlroots_pkg] if wlroots_pkg_source == 'repo' else []) }}"

- name: Ensure dwl build dependencies are installed (repo)
  community.general.pacman:
    name: "{{ dwl_repo_deps }}"
    state: present
  become: true

- name: Ensure source directory exists
  ansible.builtin.file:
    path: "{{ dwl_src_dir }}"
    state: directory
    owner: "{{ user }}"
    group: wheel
    mode: '0755'
    recurse: true
  become: true

- name: Clone or update dwl repository
  ansible.builtin.git:
    repo: "{{ dwl_repo }}"
    dest: "{{ dwl_src_dir }}"
    version: "{{ dwl_branch }}"
    force: true
    update: true
  become: true
  become_user: "{{ user }}"

- name: Build and install dwl
  community.general.make:
    chdir: "{{ dwl_src_dir }}"
    params:
      PREFIX: "{{ dwl_install_prefix }}"
    target: install
  become: true
  environment:
    PKG_CONFIG_PATH: "{{ wlroots_pc_dir }}:/usr/lib/pkgconfig"

- name: Ensure local bin exists
  ansible.builtin.file:
    path: "/home/{{ user }}/.local/bin"
    state: directory
    owner: "{{ user }}"
    group: wheel
    mode: '0755'
  become: true

- name: Ensure dwl log directory exists
  ansible.builtin.file:
    path: "/home/{{ user }}/.local/share"
    state: directory
    owner: "{{ user }}"
    group: wheel
    mode: '0755'
  become: true

- name: Ensure dwl data directory exists
  ansible.builtin.file:
    path: "/home/{{ user }}/.local/share/dwl"
    state: directory
    owner: "{{ user }}"
    group: wheel
    mode: '0755'
  become: true

- name: Install wayland session desktop entry
  ansible.builtin.file:
    path: /usr/share/wayland-sessions
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Install wayland session desktop entry
  ansible.builtin.copy:
    dest: /usr/share/wayland-sessions/{{ dwl_session_name }}.desktop
    owner: root
    group: root
    mode: '0644'
    content: |
      [Desktop Entry]
      Name={{ dwl_session_name }}
      Comment=Dynamic window manager for Wayland
      Exec={{ dwl_launcher_path }}
      Type=Application
      DesktopNames={{ dwl_session_name }}
  become: true

- name: Clone or update slstatus repository
  ansible.builtin.git:
    repo: "{{ slstatus_repo }}"
    dest: "{{ slstatus_src_dir }}"
    version: "{{ slstatus_branch }}"
    force: true
    update: true
  become: true
  become_user: "{{ user }}"

- name: Build and install slstatus
  community.general.make:
    chdir: "{{ slstatus_src_dir }}"
    target: install
    params:
      PREFIX: "{{ slstatus_install_prefix }}"
  become: true

- name: Ensure wallpapers directory exists
  ansible.builtin.file:
    path: "/home/{{ user }}/.local/share/wallpapers"
    state: directory
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: "0755"
  become: true

- name: Copy wallpaper.jpg to wallpapers directory
  ansible.builtin.copy:
    src: "wallpaper.jpg"
    dest: "/home/{{ user }}/.local/share/wallpapers/wallpaper.jpg"
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: "0644"
  become: true
