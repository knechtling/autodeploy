---
- name: Install emptty
  community.general.pacman:
    name: emptty
    state: present
  become: true

- name: Ensure emptty PAM configuration is present and correct
  block:
    - name: Check if /etc/pam.d/emptty exists
      ansible.builtin.stat:
        path: /etc/pam.d/emptty
      register: emptty_pam

    - name: Install correct /etc/pam.d/emptty
      ansible.builtin.copy:
        dest: /etc/pam.d/emptty
        owner: root
        group: root
        mode: "0644"
        content: |
          #%PAM-1.0
          auth        include     system-local-login
          account     include     system-local-login
          password    include     system-local-login
          session     include     system-local-login
      become: true
  when: emptty_manage_pam | default(false)
  tags: ['pam', 'emptty']

- name: Remove custom emptty PAM file when management disabled
  ansible.builtin.file:
    path: /etc/pam.d/emptty
    state: absent
  become: true
  when: not (emptty_manage_pam | default(false))

- name: Create emptty config directory
  ansible.builtin.file:
    path: /etc/emptty
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Configure emptty
  ansible.builtin.template:
    src: emptty.conf.j2
    dest: /etc/emptty/conf
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: restart emptty

- name: Disable other display managers
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: false
    state: stopped
  become: true
  loop:
    - gdm.service
    - sddm.service
    - lightdm.service
  failed_when: false
  ignore_errors: true

- name: Enable emptty service
  ansible.builtin.systemd:
    name: emptty.service
    enabled: true
  become: true
  when: emptty_enabled | default(true)
