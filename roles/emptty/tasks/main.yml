---
- name: Install emptty
  community.general.pacman:
    name: emptty
    state: present
  become: true

- name: Ensure /etc/emptty exists
  ansible.builtin.file:
    path: /etc/emptty
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true

- name: Write /etc/emptty/conf (autologin disabled)
  ansible.builtin.template:
    src: emptty.conf.j2
    dest: /etc/emptty/conf
    owner: root
    group: root
    mode: "0644"
  become: true

- name: Ensure /tmp/emptty exists with correct permissions
  ansible.builtin.file:
    path: /tmp/emptty
    state: directory
    owner: root
    group: root
    mode: "0700"
  become: true

- name: Remove stale emptty retry files
  ansible.builtin.find:
    paths: /tmp/emptty
    file_type: any
  register: emptty_tmp_files
  become: true

- name: Clean /tmp/emptty
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ emptty_tmp_files.files }}"
  when: emptty_tmp_files.matched | default(0, true) | int > 0
  become: true

- name: Ensure ~/.config exists
  ansible.builtin.file:
    path: "/home/{{ user }}/.config"
    state: directory
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: "0755"
  become: true

- name: Remove incorrect emptty config directory
  ansible.builtin.stat:
    path: "/home/{{ user }}/.config/emptty"
  register: emptty_config_dir
  become: true

- name: Delete ~/.config/emptty when it is a directory
  ansible.builtin.file:
    path: "/home/{{ user }}/.config/emptty"
    state: absent
  when: emptty_config_dir.stat.isdir | default(false)
  become: true

- name: Write minimal ~/.config/emptty.conf
  ansible.builtin.copy:
    dest: "/home/{{ user }}/.config/emptty.conf"
    content: |-
      # emptty user configuration (optional overrides)
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: "0600"
  become: true

- name: Ensure emptty systemd override directory exists
  ansible.builtin.file:
    path: /etc/systemd/system/emptty.service.d
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true

- name: Set explicit emptty config path via systemd drop-in
  ansible.builtin.copy:
    dest: /etc/systemd/system/emptty.service.d/override.conf
    owner: root
    group: root
    mode: "0644"
    content: |-
      [Service]
      ExecStart=
      ExecStart=/usr/bin/emptty --config /home/{{ user }}/.config/emptty.conf
  notify: restart emptty
  become: true

- name: Reload systemd to apply emptty override
  ansible.builtin.systemd:
    daemon_reload: true
  become: true
